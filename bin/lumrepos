#!/usr/bin/env php
<?php

/*
 * A simple script to build a composer-dev.json out of a composer.json
 * and one or more composer-dev-repos.json with overrides to apply.
 *
 * For new "repositories" entry, we'll add that to the generated config,
 * and if it is a "path" repository, and has it's own composer-dev-repos.json
 * we'll recurse into that file as well. We'll only add each repository once,
 * so no worries about infinite recursion or whatnot.
 *
 * In addition to adding the custom repos, we can also overridde entries in 
 * the "require" and "require-dev" sections. If you set a package value to 
 * null, it will be removed from that section. For each section we will only
 * override a single package name once. The first file to override it "wins".
 *
 * A couple special options can be set in the composer-dev-repos.json which
 * aren't added to the composer-dev.json but affect the construction of it.
 *
 *  "pretty": true
 *
 *    Will use JSON_PRETTY_PRINT for composer-dev.json
 *
 *  "more-fields": []
 *
 *    The names of extra fields in addition to "require" and "require-dev" 
 *    to be added from this configuration file. The same rules apply for these
 *    fields as for the "require" and "require-dev" fields.
 *
 *    In addition to removing individual properties from a section by setting
 *    the property value to null, you can unset an entire section by setting 
 *    it's value to null instead of an object/array.
 *
 * You can then run composer with the 'dev' configuration using:
 *
 *   COMPOSER=composer-dev.json composer <command>
 *
 * See the 'lumc' script for a simplistic wrapper.
 *
 */

const REPOS  = 'repositories';
const REQ    = 'require';
const REQDEV = 'require-dev';
const URL    = 'url';
const TYPE   = 'type';
const PATH   = 'path';
const PRETTY = 'pretty';
const MORE   = 'more-fields';

const RF = 'composer-dev-repos.json';
const CF = 'composer.json';
const DF = 'composer-dev.json';

if (!file_exists(CF))
  throw new Exception("Missing ".CF);

if (!file_exists(RF))
  throw new Exception("Missing ".RF);

function get_json($file, $fatal=false)
{
  $json = json_decode(file_get_contents($file), true);
  if (!$json)
  { // Wasn't able to parse the JSON document.
    $msg = "Could not parse '$file' as a valid JSON file";
    if ($fatal)
    {
      throw new Exception($msg);
    }
    else
    {
      error_log($msg);
    }
  }
  return $json;
}

// A private class specifically for this script
class DevConf
{
  private bool $pretty = false;
  private array $overridden = [];
  private array $seen = [];
  private array $conf;

  public function __construct()
  {
    $this->conf = get_json(CF, true);

    error_log("Loading '".CF."' as template config.");

    if (isset($this->conf[REPOS]))
    {
      foreach ($this->conf[REPOS] as $repo)
      {
        $this->see($repo);
      }
    }
  }

  private function see(array $repo): bool
  {
    if (isset($repo[URL]))
    {
      $url = $repo[URL];
      if (isset($this->seen[$url]))
      { // Already been seen.
        return false;
      }
      else
      { // Hasn't been seen yet, mark it down and process it.
        $this->seen[$url] = true;
        return true;
      }
    }
    else
    {
      error_log("Skipping repository that was missing '".URL."' property:" 
        . json_encode($repo));
      return false;
    }
  }

  public function add($mergefile, $toplevel=false): void
  {
    $rconf = get_json($mergefile);
    if (!$rconf) return;

    error_log("Adding '$mergefile' rules to development config.");

    if ($toplevel && isset($rconf[PRETTY]) && is_bool($rconf[PRETTY]))
    {
      $this->pretty = $rconf[PRETTY];
    }

    if (isset($rconf[REPOS]))
    { // Custom repositories.
      foreach ($rconf[REPOS] as $repo)
      {
        if (!$this->see($repo))
        { // That repo is either invalid, or has already been seen.
          continue;
        }
  
        // Add the repository definition to our list.
        $this->conf[REPOS][] = $repo;
  
        if ($repo[TYPE] == PATH)
        { // It's another path, see if it has a custom repos file.
          $rdir = rtrim($repo[URL], '/');
          $rfile = $rdir.'/'.RF;
          if (file_exists($rfile))
          { // Another custom repo definition file, add it.
            $this->add($rfile);
          }
        }
  
      } // foreach repo
    } // if repos

    // Default fields to look for.
    $fields = [REQ, REQDEV];
    if (isset($rconf[MORE]) && is_array($rconf[MORE]))
    { // Extra fields were defined, look for them too.
      $fields = array_merge($fields, $rconf[MORE]);
    }

    // Look for sections to override.
    foreach ($fields as $rkey)
    {
      if (array_key_exists($rkey, $rconf))
      {
        $rval = $rconf[$rkey];
        if (is_null($rval))
        { // A null value can be used to remove an entire section.
          if (isset($this->conf[$rkey]) && !isset($this->overridden[$rkey]))
          { // It's not been overridden, remove it.
            unset($this->conf[$rkey]);
            $this->overridden[$rkey] = true;
          }
        }
        elseif (is_array($rval))
        { // It's a PHP array, let's keep track of it's nested properties.
          if (!isset($this->overridden[$rkey]))
          { // Add a storage container for overridden values.
            $this->overridden[$rkey] = [];
          }
          elseif (!is_array($this->overridden[$rkey]))
          { // The property was overridden, but wasn't an array.
            continue;
          }

          if (!isset($this->conf[$rkey]))
          { // Add an empty array, we'll populate it below.
            $this->conf[$rkey] = [];
          }

          foreach ($rval as $okey => $oval)
          { // Add or update the keys.
            if (!isset($this->overridden[$rkey][$okey]))
            { // Override the config item.
              if (is_null($oval))
              { // The null value is used to delete properties.
                unset($this->conf[$rkey][$okey]);
              }
              else
              { // Any other value will be assigned.
                $this->conf[$rkey][$okey] = $oval;
              }
              // Mark it as overridden so we can skip it next time.
              $this->overridden[$rkey][$okey] = true;
            }
          }

        }
        else
        { // It's something other than an array or null.
          if (!isset($this->overridden[$rkey]))
          {
            $this->conf[$rkey] = $rval;
            $this->overridden[$rkey] = true;
          }
        }

      } // if rkey exists

    } // foreach rkey

  } // function add

  public function save()
  {
    $flags = $this->pretty ? JSON_PRETTY_PRINT : 0;
    file_put_contents(DF, json_encode($this->conf, $flags));
  }

}

error_log("Building '".DF."' development config.");

$devconf = new DevConf();
$devconf->add(RF, true);
$devconf->save();

